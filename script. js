// -----------------------------------------------------
// IMPORTS
// -----------------------------------------------------
import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.module.js";
import { GLTFLoader } from "https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/loaders/GLTFLoader.js";
import * as SkeletonUtils from "https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/utils/SkeletonUtils.js";
import { GUI } from "https://cdn.jsdelivr.net/npm/lil-gui@0.18/dist/lil-gui.esm.js";

// -----------------------------------------------------
// SCENE + CAMERA + RENDERER
// -----------------------------------------------------
const scene = new THREE.Scene();

const camera = new THREE.PerspectiveCamera(
    70,
    window.innerWidth / window.innerHeight,
    0.01,
    100
);

camera.position.set(0, 1.6, 3);

const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(window.devicePixelRatio);
document.body.appendChild(renderer.domElement);

// -----------------------------------------------------
// LIGHTS
// -----------------------------------------------------
const light1 = new THREE.HemisphereLight(0xffffff, 0x444444, 1);
scene.add(light1);

const dirLight = new THREE.DirectionalLight(0xffffff, 1);
dirLight.position.set(5, 10, 7);
scene.add(dirLight);

// -----------------------------------------------------
// LOAD MODEL
// -----------------------------------------------------
const loader = new GLTFLoader();
let riggedModel;

loader.load(
    "assets/models/model.glb",
    function (gltf) {
        const model = gltf.scene;

        // Clone with proper skeleton
        riggedModel = SkeletonUtils.clone(model);
        scene.add(riggedModel);

        setupRigEditor(riggedModel);
    },
    undefined,
    function (err) {
        console.error("GLB Load Error:", err);
    }
);

// -----------------------------------------------------
// RIGGING SYSTEM
// -----------------------------------------------------
function setupRigEditor(model) {
    // Collect bones
    const bones = [];
    model.traverse(o => {
        if (o.isBone) bones.push(o);
    });

    // ---------------- GUI ----------------
    const gui = new GUI();
    gui.title("Rig Controls");

    bones.forEach(bone => {
        const f = gui.addFolder(bone.name);
        f.add(bone.rotation, "x", -Math.PI, Math.PI, 0.01);
        f.add(bone.rotation, "y", -Math.PI, Math.PI, 0.01);
        f.add(bone.rotation, "z", -Math.PI, Math.PI, 0.01);
    });

    // ---------------- Skeleton Helper ----------------
    const helper = new THREE.SkeletonHelper(model);
    helper.visible = true;
    scene.add(helper);

    // ---------------- Bone Selection ----------------
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    let selectedBone = null;

    function selectBone(event) {
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

        raycaster.setFromCamera(mouse, camera);
        const hits = raycaster.intersectObject(helper, true);

        if (hits.length > 0) {
            selectedBone = hits[0].object.bone;
            console.log("Selected Bone:", selectedBone.name);
        }
    }

    window.addEventListener("pointerdown", selectBone);

    // ---------------- Drag Rotate ----------------
    let dragging = false;

    window.addEventListener("pointerdown", () => dragging = true);
    window.addEventListener("pointerup", () => dragging = false);

    window.addEventListener("pointermove", (event) => {
        if (dragging && selectedBone) {
            selectedBone.rotation.y += event.movementX * 0.01;
            selectedBone.rotation.x += event.movementY * 0.01;
        }
    });

    // Keep skeleton lines updated
    function updateHelper() {
        helper.update();
        requestAnimationFrame(updateHelper);
    }
    updateHelper();
}

// -----------------------------------------------------
// RESIZE HANDLER
// -----------------------------------------------------
window.addEventListener("resize", () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});

// -----------------------------------------------------
// ANIMATE LOOP
// -----------------------------------------------------
function animate() {
    requestAnimationFrame(animate);
    renderer.render(scene, camera);
}

animate();
