// server.js
const express = require('express');
const http = require('http');
const { Server } = require('socket.io');

const app = express();
const server = http.createServer(app);

// Configure CORS for your GitHub Pages URL!
const io = new Server(server, {
    cors: {
        origin: "https://YOUR-GITHUB-USERNAME.github.io", // Replace this!
        methods: ["GET", "POST"]
    }
});

const players = {}; // Player state map: { socket.id: { position: {}, rotation: 0, action: 'idle' } }
const PORT = process.env.PORT || 3000;

io.on('connection', (socket) => {
    console.log('A user connected:', socket.id);
    players[socket.id] = { position: { x: 0, y: 0, z: 0 }, rotation: 0, action: 'idle' };

    // 1. Tell the new client about all existing players
    socket.emit('currentPlayers', players);

    // 2. Tell all other clients about the new player
    socket.broadcast.emit('newPlayer', { id: socket.id, player: players[socket.id] });

    // 3. Listen for player updates from the client
    socket.on('playerUpdate', (data) => {
        players[socket.id] = data;
    });

    // 4. Handle disconnection
    socket.on('disconnect', () => {
        console.log('User disconnected:', socket.id);
        delete players[socket.id];
        // Tell everyone that a player left
        io.emit('removePlayer', socket.id);
    });
});

// Game Loop: Broadcast all player positions 20 times per second (50ms)
setInterval(() => {
    io.emit('playerStates', players);
}, 50);

server.listen(PORT, () => {
    console.log(`Server listening on port ${PORT}`);
});
